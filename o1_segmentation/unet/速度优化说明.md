# 训练速度优化说明

## 🐌 问题诊断

原训练速度过慢的原因：
1. **验证阶段瓶颈**：每个验证样本都使用sliding_window_inference，roi_size=(160,160,128)，overlap=0.5
   - 导致每个大图像要切很多小块（可能几十到上百个）
   - 83个验证样本 × 50秒/样本 ≈ 69分钟/epoch
   - 加上训练时间，每个epoch约2小时

2. **数据加载未优化**：pin_memory=False，数据传输慢

3. **Batch size偏小**：训练batch_size=2，验证batch_size=1

## ⚡ 已实施的优化

### 1. 智能验证策略（最重要）
- **大部分epoch使用直接forward**：速度快10-50倍
- **每10个epoch使用sliding window**：保证准确性
- **前5个epoch使用sliding window**：确保早期训练准确性

**预期加速**：验证时间从~70分钟 → ~5-10分钟（非sliding window epoch）

### 2. Sliding Window参数优化
- **roi_size**: (160,160,128) → (256,256,192) - 更大ROI，更少切块
- **overlap**: 0.5 → 0.25 - 减少重叠，更快
- **sw_batch_size**: 4 → 8 - 并行处理更多patch

**预期加速**：sliding window时间减少约50-60%

### 3. 数据加载优化
- **pin_memory**: False → True - 加速CPU到GPU数据传输
- **验证batch_size**: 1 → 2 - 并行处理更多样本

### 4. 训练batch_size增加
- **训练batch_size**: 2 → 4 - 如果GPU内存足够，可以进一步提升

## 📊 预期速度提升

| 阶段 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| 训练阶段 | ~30-40分钟 | ~20-30分钟 | 1.3-2x |
| 验证（直接forward） | ~70分钟 | ~5-10分钟 | **7-14x** |
| 验证（sliding window） | ~70分钟 | ~30-40分钟 | 1.75-2.3x |
| **总时间/epoch** | **~2小时** | **~30-50分钟** | **2.4-4x** |

**200 epochs总时间**：
- 优化前：~400小时（16.7天）
- 优化后：~100-167小时（4-7天）

## ⚠️ 注意事项

1. **GPU内存**：如果batch_size=4导致OOM，可以降低到3或保持2
2. **验证准确性**：每10个epoch的sliding window验证保证最终准确性
3. **直接forward vs sliding window**：
   - 直接forward：快，但可能对超大图像有边界效应
   - Sliding window：慢，但更准确，适合最终评估

## 🔧 进一步优化建议（如果还需要更快）

1. **减少验证频率**：每2-3个epoch验证一次（而不是每个epoch）
2. **使用更小的验证集**：随机采样部分验证样本
3. **梯度累积**：如果batch_size不能再增加，可以用梯度累积
4. **混合精度训练**：已启用，保持

## 📝 代码变更总结

- `train.py`: 智能验证策略，优化sliding window参数
- `data_loader.py`: 启用pin_memory，增加batch_size

现在可以重新开始训练，速度应该会显著提升！

